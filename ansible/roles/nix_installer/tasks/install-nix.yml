---
- name: Check if Nix is installed
  ansible.builtin.command: which nix
  register: nix_installer_installed
  changed_when: false
  ignore_errors: true

- name: Set should_install_nix fact
  ansible.builtin.set_fact:
    nix_installer_should_install: "{{ nix_installer_installed.rc != 0 }}"

- name: Install Nix
  when: nix_installer_should_install
  block:
    - name: Download installer script
      ansible.builtin.get_url:
        url: "https://nixos.org/nix/install"
        dest: "{{ nix_installer_script_dir }}/install_nix.sh"
        mode: "0755"

    - name: Run installer script (multi-user on macOS)
      ansible.builtin.command: "{{ nix_installer_script_dir }}/install_nix.sh --daemon"
      changed_when: true
      when: ansible_os_family == "Darwin"

    - name: Run installer script (standard on Linux)
      ansible.builtin.command: "{{ nix_installer_script_dir }}/install_nix.sh"
      changed_when: true
      when: ansible_os_family != "Darwin"

- name: Verify Nix daemon is running (macOS)
  when:
    - nix_installer_should_install
    - ansible_os_family == "Darwin"
  block:
    - name: Check if nix-daemon service is loaded
      ansible.builtin.command: launchctl list org.nixos.nix-daemon
      register: nix_daemon_status
      changed_when: false
      failed_when: false

    - name: Load nix-daemon service if not running
      become: true
      ansible.builtin.command: launchctl load /Library/LaunchDaemons/org.nixos.nix-daemon.plist
      when: nix_daemon_status.rc != 0
      changed_when: true
